#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <io.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include "includes.h"
#include "simple_socket_server.h"
#include "alt_error_handler.h"
#include "ipport.h"
#include "tcpport.h"
#include "libport.h"
#include "osport.h"

#define MAX_CHARS 1000

// Endereços dos registradores User_HW
#define ADDR_CONTROL 0
#define ADDR_DATA    1
#define ADDR_READY   2
#define ADDR_OUTPUT  3

OS_STK SSSInitialTaskStk[TASK_STACKSIZE];

// ======================================================
// PROCESSAMENTO NO HARDWARE
// ======================================================
unsigned char process_byte(unsigned char byte) {
    IOWR(USERHW_0_BASE, ADDR_DATA, byte);      // envia byte
    IOWR(USERHW_0_BASE, ADDR_CONTROL, 1);      // start

    while (IORD(USERHW_0_BASE, ADDR_READY) == 0); // espera ready

    unsigned int ans = IORD(USERHW_0_BASE, ADDR_OUTPUT); // recebe
    IOWR(USERHW_0_BASE, ADDR_CONTROL, 0);     // limpa start

    return (unsigned char)(ans & 0xFF);
}

void process_string(unsigned char* input, unsigned char* output, int length) {
    for (int i = 0; i < length; i++)
        output[i] = process_byte(input[i]);
}

// ======================================================
// SERVIDOR TCP – porta 8080
// ======================================================
void tcp_server(void *p) {
    int sock, client;
    struct sockaddr_in addr, cli;
    char recv_buffer[MAX_CHARS+1];
    unsigned char send_buffer[MAX_CHARS];
    int bytes;

    // inicialização do TCP/IP stack
    alt_iniche_init();
    netmain();

    // aguarda DHCP pegar IP
    while (iniche_net_ready == 0) {
        TK_SLEEP(10);
    }

    printf("Rede pronta. IP obtido via DHCP.\n");

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0) { printf("Erro criando socket\n"); return; }

    memset(&addr, 0, sizeof(addr));
    addr.sin_family = AF_INET;
    addr.sin_port = htons(8080); // porta 8080
    addr.sin_addr.s_addr = INADDR_ANY;

    if (bind(sock, (struct sockaddr *)&addr, sizeof(addr)) < 0) {
        printf("bind() falhou\n");
        close(sock);
        return;
    }

    listen(sock, 1);
    printf("Servidor TCP pronto na porta 8080\n");

    while (1) {
        int cli_len = sizeof(cli);
        client = accept(sock, (struct sockaddr *)&cli, &cli_len);
        if (client < 0) { printf("Erro no accept\n"); continue; }

        printf("Cliente conectado.\n");
        memset(recv_buffer, 0, sizeof(recv_buffer));

        bytes = recv(client, recv_buffer, sizeof(recv_buffer), 0);
        if (bytes <= 0) {
            printf("Cliente desconectou antes de enviar.\n");
            close(client);
            continue;
        }

        // Encontrar início do body (HTTP simplificado)
        char* body = strstr(recv_buffer, "\r\n\r\n");
        if (body) body += 4;

        // calcular tamanho correto do body
        int body_len = bytes - (body - recv_buffer);
        if (body_len < 0) body_len = 0;
        if (body_len > MAX_CHARS) body_len = MAX_CHARS;

        // Processamento User_HW
        process_string((unsigned char*)body, send_buffer, body_len);

        // Envio da resposta
        int sent = send(client, send_buffer, body_len, 0);
        if (sent < 0) {
            printf("Erro ao enviar resposta\n");
        } else {
            printf("Enviado de volta: %d bytes\n", sent);
            printf("Resposta (hex): ");
            for (int i = 0; i < body_len; i++)
                printf("%02X ", send_buffer[i]);
            printf("\n");
        }

        // Fecha conexão
        close(client);
    }

    close(sock);
}

// ======================================================
// MAIN – cria a thread do servidor TCP
// ======================================================
int main() {
    INT8U error_code;
    OSTimeSet(0);
    printf("Inicializando sistema...\n");

    error_code = OSTaskCreateExt(
        tcp_server,
        NULL,
        (void *)&SSSInitialTaskStk[TASK_STACKSIZE],
        SSS_INITIAL_TASK_PRIORITY,
        SSS_INITIAL_TASK_PRIORITY,
        SSSInitialTaskStk,
        TASK_STACKSIZE,
        NULL,
        0
    );
    alt_uCOSIIErrorHandler(error_code, 0);
    printf("Servidor TCP criado.\n");

    OSStart(); // inicia o MicroC/OS-II
    while(1);
    return 0;
}
